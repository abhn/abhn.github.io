<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      WebSockets &middot; Abhishek Nagekar's Blog
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">

  <!-- Icons -->
  <link rel="shortcut icon" href="/assets/images/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body>

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">



<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
    

  <nav class="sidebar-nav">
    

    
    
      
        
          <a class="sidebar-nav-item" href="/">Sometimes, I write..</a>
        
      
    
      
        
          <a class="sidebar-nav-item" href="/archive">Archive</a>
        
      
    
      
        
      
    
      
        
          <a class="sidebar-nav-item" href="/meta">Meta</a>
        
      
    
      
        
      
    
      
        
          <a class="sidebar-nav-item" href="/search">Search This Blog</a>
        
      
    
      
        
      
    
      
        
          <a class="sidebar-nav-item" href="/tags">Tags</a>
        
      
    
    <a class="sidebar-nav-item" href="https://github.com/abhn">My GitHub</a>
    <a class="sidebar-nav-item" href="/search">Search This Blog</a>
    <a class="sidebar-nav-item" onclick="window.open('https://feedburner.google.com/fb/a/mailverify?uri=AbhishekN', 'popupwindow', 'scrollbars=yes,width=550,height=520');return true" target="popupwindow" href="https://feedburner.google.com/fb/a/mailverify?uri=AbhishekN">Email Subscription</a>
    
    
  </nav>

  <div class="sidebar-item">
    <p>
      Abhishek Nagekar &copy; 2016
    <br>
      <small>Some Rights Reserved</small>
    </p>
  </div>
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Abhishek Nagekar's Blog</a>
            <small>Code, Science, Philosophy, Humor</small>
          </h3>
        </div>
      </div>
      <div class="container content">
        <div id="head-quote"></div>
        <div class="post">
  <h1 class="post-title">WebSockets</h1>
  <span class="post-date">15 April, 2016. It was a Friday.</span>
  <p>
	If you're like me, then you must have gone nuts on hearing about <a href="https://developer.mozilla.org/en-US/docs/Web/API/WebSockets_API">WebSockets</a> for the first time. We now have a totally independent protocol that will not terminate connection after a request-response cycle, which means all hacks to keep a persistent connection from the browser (long polling, I'm looking at you) would now be part of the history. Welcome to the world of WebSockets.
</p>
<p>
	Let's start with the Wikipedian and Mozillian definition of WebSockets, to get some initial traction.
</p>
<h6>Wikipedia says that..</h6>
<blockquote>
	WebSocket is a protocol providing full-duplex communication channels over a single TCP connection. The WebSocket protocol was standardized by the IETF as RFC 6455 in 2011, and the WebSocket API in Web IDL is being standardized by the W3C.
</blockquote>
<h6>Mozilla Developer Network says that..</h6>
<blockquote>
	WebSockets is an advanced technology that makes it possible to open an interactive communication session between the user's browser and a server. With this API, you can send messages to a server and receive event-driven responses without having to poll the server for a reply.
</blockquote>
<p>
	To begin with, let us all make sure we have websocket support by clicking <button id="hasBtn" onclick="hasSocket();">here</button>. Assuming you do, let's begin. Web browsers provide us with the <code>WebSocket</code> class. To create a websocket, we simply need to <pre>let ws = new WebSocket('ws://server.com/endpoint');</pre>This gives us a <i>websocket</i> object which supports methods like send() and close() and event listeners like onmessage and onerror.
</p>
<p>
	Creating a nodejs instance running a websocket server is easy with modules. I did try to do it natively, but it went too tedious. Finally I settled for <code>ws</code> module from npm. The server side code looks trival.
</p>
<script src="https://gist.github.com/abhn/d94830c3901b48ebdeb8375b37d0ee60.js"></script>
<p>
	On the browser, things are even simpler.
</p>
<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// call the object constructor</span>
<span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s1">'ws://nagekar-ws.herokuapp.com/'</span><span class="p">);</span>
<span class="c1">// attach a message listener</span>
<span class="nx">ws</span><span class="p">.</span><span class="nx">onmessage</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">msg</span><span class="p">);</span>
<span class="p">}</span>
<span class="c1">// send some message</span>
<span class="nx">ws</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s1">'hello server!'</span><span class="p">);</span></code></pre></figure>
<p>
	Once we call the constructor, an HTTP GET request is generated to initiate the transaction. You'll find that these headers are sent by your browser.
</p>
<pre>

GET / HTTP/1.1
Host: nagekar-ws.herokuapp.com
Connection:Upgrade
Pragma:no-cache
Sec-WebSocket-Extensions:permessage-deflate; client_max_window_bits
Sec-WebSocket-Key:ut0NjBQxxBnmtUStHfMUDw==
Sec-WebSocket-Version:13
Upgrade:websocket
User-Agent:Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/49.0.2623.108 Safari/537.36
</pre>
<p>
	The ones to notice are the URL, which begins with ws:// protocol. <a href="http://stackoverflow.com/questions/23674199/why-is-there-no-same-origin-policy-for-websockets-why-can-i-connect-to-ws-loc#comment36372038_23674863">Cross domain requests</a> are allowed. This initial step requires the use of HTTP(S) or web, hence the name 'web' sockets. The <i>'Connection:Upgrade'</i> and <i>'Upgrade:websocket'</i> and what requests the server to change this connection to a socket one. The <i>Sec-WebSocket-Key</i> header is what client sends to the server. The server crafts another key with this and returns it back in the response header. A response header looks like this.
</p>
<pre>
HTTP/1.1 101 Switching Protocols
Connection:Upgrade
Sec-Websocket-Accept:7CAJHdL7QMG4ceqd0M1O8SDbM2Q=
Sec-Websocket-Extensions:permessage-deflate
Upgrade:websocket
Via:1.1 vegur
</pre>
<p>
	On receiving the <i>Sec-Websocket-Accept</i> header, the handshake is completed, and now the client and server are connected via persistent sockets, ready to perform both way message delivery.
</p>
<p>
	Click 'Connect' button to initiate WebSocket handshake. The server will respond with a timestamp every 2500 milliseconds. Also, the server will echo back everything to send at it. The close button will call the WebSocket.close() method which will terminate the connection.
	<h4>Message Box</h4>
	<div id="list" style="height:100px;overflow-y:scroll;border:1px solid">
	    <ul id="msglist">

	    </ul>
    </div>
    <center>
	    <button id="connect">Connect</button>
	    <input type="text" id="inp" />
		<button id="send">Send</button>
		<button id="close">Close</button>
	</center>
</p>
<p>
	Pretty interesting, isn't it. Things get even more interesting when you use a readymade library built on top of WebSockets, such as <a href="https://socket.io">Socket.io</a>. It supports all browsers (through fallback to XHR/polling), has better looking APIs, is easy to use and allows you to broadcast without having to worry much about raw connections. If you're going to use these WebSockets in production, there's no reason not to use Socket.io. Using native websockets is not recommended if you're planning to support some legacy browsers. Even Mozilla terms it as an 'experimental technology'. Check out the <a href="https://developer.mozilla.org/en-US/docs/Web/API/WebSocket#Browser_compatibility">compatibility table</a> for more information.
</p>
<p>
	I hope this post was informative. I did learn a lot while researching on this topic, and I'm glad I did. As always, thank you for reading. Please drop a comment in case of feedback or correction.
</p>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.0.0-beta1/jquery.min.js"></script>
<script type="text/javascript">
	function hasSocket() {
		if(window.WebSocket) {
			document.getElementById('hasBtn').innerHTML = 'Supported';
			document.getElementById('hasBtn').disabled = true;
		} else {
			document.getElementById('hasBtn').innerHTML = 'Not supported';
			document.getElementById('hasBtn').disabled = true;
		}
	}
	var ws;
	$('#connect').click(function() {
		ws = new WebSocket('wss://nagekar-ws.herokuapp.com/');
		ws.onmessage = function(msg) {
			$('#msglist').append('<li style="color: green">' + msg.data + '</li>').focus();
			$('#list').scrollTop($('ul li').last().position().top + $('ul li').last().height());
		};
	});
	$('#send').click(function() {
		var msg = $('#inp').val();
		$('#msglist').append('<li style="color: blue">Message to server: ' + msg + '</li>').focus();
		$('#list').scrollTop($('ul li').last().position().top + $('ul li').last().height());
		ws.send(msg);
	});
	$('#close').click(function() {
		ws.close();
		$('#msglist').append('<li style="color: red">' + 'Connection Closed' + '</li>').focus();
		$('#list').scrollTop($('ul li').last().position().top + $('ul li').last().height());
	})
</script>

</div>

<div class="related">
  <h2>You May Also Like</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/2016/05/_generic-in-C.html">
            _Generic in C And Generic LinkedList Implementation
            <small>15 Apr 2016</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2016/04/being-stupid.html">
            Being Stupid
            <small>15 Apr 2016</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2016/04/googling-life.html">
            Googling And Asking Better Questions
            <small>15 Apr 2016</small>
          </a>
        </h3>
      </li>
    
  </ul>
  <hr>
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <ins class="adsbygoogle"
         style="display:block"
         data-ad-client="ca-pub-2314128584981990"
         data-ad-slot="1513670662"
         data-ad-format="auto"></ins>
    <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
  <hr>
  


  <div id="disqus_thread"></div>
<script type="text/javascript">
    
    var disqus_developer = 1;
    var disqus_shortname = 'nagekar'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>




</div>

      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

    <script>
      (function(document) {
        var toggle = document.querySelector('.sidebar-toggle');
        var sidebar = document.querySelector('#sidebar');
        var checkbox = document.querySelector('#sidebar-checkbox');

        document.addEventListener('click', function(e) {
          var target = e.target;

          if(!checkbox.checked ||
             sidebar.contains(target) ||
             (target === checkbox || target === toggle)) return;

          checkbox.checked = false;
        }, false);
      })(document);
    </script>
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-74790644-1', 'auto');
        ga('send', 'pageview');
    </script>
    <script>
        var txtFile = new XMLHttpRequest();
        txtFile.open("GET", "/quotes.txt", true);
        txtFile.onreadystatechange = () => {
          if (txtFile.readyState === 4) {  
            if (txtFile.status === 200) { 
              allText = txtFile.responseText; 
              lines = txtFile.responseText.split("\n");
              randLine = lines[Math.floor((Math.random() * lines.length) + 1)];
              document.getElementById('head-quote').innerHTML = '<p class="message" style="font-size: 14px; font-color: grey; text-align: center;">' + randLine + '<small></p>';
            }
          }
        }
        txtFile.send(null);
    </script>
  </body>
</html>
