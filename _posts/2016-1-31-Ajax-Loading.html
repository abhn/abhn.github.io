---
layout: post
title: AJAX Loading - Part 1
---

<p>
	I always admired the sites which did not reload upon clicking links here and there, but simple gave me whatever I requested for, with grace. Sites like Facebook, Twitter and Youtube extensively use it, and the application hardly reloads after the initial reload. Here's my attempt on making something similar.
</p>
<p>
	Firstly, I downloaded a free HTML template from <a href="http://www.onlinecasinos.im/" target="_blank">Online Casinos</a>. The links had to be edited. The pattern I used was to replace, for example, any (internal) link pointing to <code>example.html</code> to <code>#/example.html</code>. What it did was 1.) prevent the page from reloading, and 2.) putting the requested location to some place from where I can extract it with Javascript.
</p>
<p>
	Next, grab that location of the hash. The Javascript's built in method <code>window.location.hash</code> provides the page's current hash. We drop the first char from the returned hash as it is the hash (#) character itself. The hash value is essentially the location to be navigated to, hence, we use some string manipulation to craft a new URL from it, and make an AJAX request to fetch the contents of the page requested, and insert it into the div specified through Javascript.
</p>
<p>
	For example, suppose we are on about.html page. Now if I click 'contact' link, the link would change to /about.html#/contact.html, the hash value would be grabbed by the window.location.hash method, a GET request is fired to get that location with a XMLHttpRequest object, the response is inserted with innerHTML method on the div, and using the <code>window.history.pushState()</code> method, we update the URL to /contact.html, to ease sharing. All this, in the blink of an eye. Cool.
</p>
<p>
	I could do it in two different ways. One was to just place the text in those files and inserting them into the template. The drawback of this was that if a user directly visits that page, he/she would just see plain text. For example, <a href="/assets/ajaxreload/index.html">check this link out</a>. The Javascript code for that was,
</p>
<pre>
var elements = document.getElementsByTagName('a'); // grab all hyperlinks

for(var i = 0, len = elements.length; i < len; i++) { // for every hyperlink
    elements[i].onclick = function () {
        var xmlObj = new XMLHttpRequest();
        xmlObj.addEventListener('load', function() {
            var res = this.responseText;
            var main = document.getElementById('main');
            main.innerHTML = res;
        });

        getHash(function(hash) {
            var url = 'template2' + hash; // hack for Webstorm IDE, sorry I don't regex
            url = 'http://' + window.location.host + '/' + url;
            console.log(url);
            xmlObj.open('GET', url);
            xmlObj.send();
            window.history.pushState('', '', url); // update the address bar for ease of url sharing (optional)
        });

    }
}

function getHash(callback) {
    window.onhashchange = function() {
        if(window.location.hash == '') { // in case the page clicked is index
            window.location = 'http://' + window.location.host + '/template2';
        }
        callback(window.location.hash.substr(1)); // get the hash and drop the first character
    }
}
</pre>
<p>
	The separate callback function for getHash was necessary because onclick() event fires before the hash is changed, and it would result in the script grabbing the previous hash. As already mentioned, the navigation is smooth if one visits index.html and then other links, but try getting the about.html page first. All you'll see are a few lines of text.
</p>
<p>
	A sloppy solution to the above problem was to replicate the entire index page with varying content for each of the page, and then replace entire DOM on anchor click. You can imagine this is not at all smart, and would destroy the point of this site. Not to mention the extra bandwidth to reload the same resources on every request. <a href="/assets/ajaxreload2/index.html">Here is the implementation</a> for this method.
</p>
<p>
	What would be the smarter way? Perhaps, making sure the first page to load always downloads the entire html every time, and subsequent requests to be made to download the changed content. I will be implementing this solution shortly. Drop in your ideas too, and share if you enjoyed reading this. 
</p>